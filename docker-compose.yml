services:
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-nmpa}
      POSTGRES_USER: ${POSTGRES_USER:-nmpa}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-nmpa}
    ports:
      - "5432:5432"
    command:
      - postgres
      - -c
      - wal_level=replica
      - -c
      - archive_mode=on
      - -c
      - archive_timeout=300
      - -c
      - archive_command=test ! -f /var/lib/postgresql/wal-archive/%f && cp %p /var/lib/postgresql/wal-archive/%f
    volumes:
      - ./.local/pgdata:/var/lib/postgresql/data
      - ./backups/postgres/wal:/var/lib/postgresql/wal-archive
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-nmpa} -d ${POSTGRES_DB:-nmpa}"]
      interval: 5s
      timeout: 3s
      retries: 20

  db-backup:
    image: postgres:16
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD:-nmpa}
      PGHOST: db
      PGPORT: ${POSTGRES_PORT:-5432}
      PGUSER: ${POSTGRES_USER:-nmpa}
      PGDATABASE: ${POSTGRES_DB:-nmpa}
      BACKUP_DIR: /backup
      WAL_ARCHIVE_DIR: /wal
      BACKUP_RUN_AT: ${BACKUP_RUN_AT:-03:30}
      FULL_BACKUP_WEEKDAY: ${FULL_BACKUP_WEEKDAY:-1}
      FULL_BACKUP_RETENTION_WEEKS: ${FULL_BACKUP_RETENTION_WEEKS:-4}
      WAL_RETENTION_DAYS: ${WAL_RETENTION_DAYS:-14}
      TZ: ${TZ:-Asia/Shanghai}
    depends_on:
      db:
        condition: service_healthy
    command: >
      sh -c "mkdir -p /backup &&
             echo '[backup-scheduler] run_at=${BACKUP_RUN_AT:-03:30} full_backup_weekday=${FULL_BACKUP_WEEKDAY:-1}' &&
             while true; do
               now_date=$$(date +%F);
               now_time=$$(date +%H:%M);
               last_date='';
               if [ -f /backup/.last_backup_run_date ]; then last_date=$$(cat /backup/.last_backup_run_date || true); fi;
               if [ \"$$now_time\" = \"${BACKUP_RUN_AT:-03:30}\" ] && [ \"$$last_date\" != \"$$now_date\" ]; then
                 echo \"[backup-scheduler] daily cycle start date=$$now_date time=$$now_time\";
                 sh /scripts/backup_pg_wal_daily.sh;
                 weekday=$$(date +%u);
                 if [ \"$$weekday\" = \"${FULL_BACKUP_WEEKDAY:-1}\" ]; then sh /scripts/backup_pg_weekly_full.sh; fi;
                 echo \"$$now_date\" > /backup/.last_backup_run_date;
                 echo \"[backup-scheduler] daily cycle done date=$$now_date\";
                 sleep 65;
                 continue;
               fi;
               sleep 20;
             done"
    volumes:
      - ./scripts/db_backup_scheduler.sh:/scripts/db_backup_scheduler.sh:ro
      - ./scripts/backup_pg_weekly_full.sh:/scripts/backup_pg_weekly_full.sh:ro
      - ./scripts/backup_pg_wal_daily.sh:/scripts/backup_pg_wal_daily.sh:ro
      - ./backups/postgres:/backup
      - ./backups/postgres/wal:/wal
    restart: unless-stopped

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://${POSTGRES_USER:-nmpa}:${POSTGRES_PASSWORD:-nmpa}@db:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-nmpa}}
      AUTH_SECRET: ${AUTH_SECRET:-local-dev-auth-secret}
      AUTH_COOKIE_NAME: ${AUTH_COOKIE_NAME:-ivd_session}
      AUTH_SESSION_TTL_HOURS: ${AUTH_SESSION_TTL_HOURS:-168}
      AUTH_COOKIE_SECURE: ${AUTH_COOKIE_SECURE:-false}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://127.0.0.1:3000}
      # Admin bootstrap account (created/updated on api startup)
      BOOTSTRAP_ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      BOOTSTRAP_ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin12345}
      DATA_SOURCES_CRYPTO_KEY: ${DATA_SOURCES_CRYPTO_KEY:-local-dev-data-sources-key}
      STAGING_DIR: ${STAGING_DIR:-/app/staging}
      USE_REGISTRATION_ANCHOR: ${USE_REGISTRATION_ANCHOR:-false}
      PENDING_QUEUE_MODE: ${PENDING_QUEUE_MODE:-document_only}
      REGISTRATION_ANCHOR_GATE_ENABLED: ${REGISTRATION_ANCHOR_GATE_ENABLED:-true}
      REGISTRATION_ANCHOR_GATE_MAX_RATIO: ${REGISTRATION_ANCHOR_GATE_MAX_RATIO:-0.05}
      REGISTRATION_ANCHOR_GATE_MAX_UNANCHORED_COUNT: ${REGISTRATION_ANCHOR_GATE_MAX_UNANCHORED_COUNT:-500}
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/docs', timeout=2).read(); print('ok')\""]
      interval: 5s
      timeout: 3s
      retries: 30
    command: >
      sh -c "python -m app.db.migrate && uvicorn app.main:app --host 0.0.0.0 --port 8000"
    volumes:
      - ./staging:/app/staging
      - ./migrations:/app/migrations:ro
      - "/Users/GY/Documents/IIVD/000001 小桔灯网/4 数据库/注册产品库/udi/UDID_FULL_RELEASE_20260205:/data/udi:ro"
    restart: unless-stopped

  worker:
    build:
      context: ./api
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://${POSTGRES_USER:-nmpa}:${POSTGRES_PASSWORD:-nmpa}@db:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-nmpa}}
      AUTH_SECRET: ${AUTH_SECRET:-local-dev-auth-secret}
      AUTH_COOKIE_NAME: ${AUTH_COOKIE_NAME:-ivd_session}
      AUTH_SESSION_TTL_HOURS: ${AUTH_SESSION_TTL_HOURS:-168}
      AUTH_COOKIE_SECURE: ${AUTH_COOKIE_SECURE:-false}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://127.0.0.1:3000}
      BOOTSTRAP_ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      BOOTSTRAP_ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin12345}
      DATA_SOURCES_CRYPTO_KEY: ${DATA_SOURCES_CRYPTO_KEY:-local-dev-data-sources-key}
      STAGING_DIR: ${STAGING_DIR:-/app/staging}
      SYNC_INTERVAL_SECONDS: ${SYNC_INTERVAL_SECONDS:-86400}
      NMPA_UDI_DOWNLOAD_PAGE: ${NMPA_UDI_DOWNLOAD_PAGE:-https://udi.nmpa.gov.cn/download.html}
      DOWNLOAD_BASE_URL: ${DOWNLOAD_BASE_URL:-https://udi.nmpa.gov.cn}
      USE_REGISTRATION_ANCHOR: ${USE_REGISTRATION_ANCHOR:-false}
      PENDING_QUEUE_MODE: ${PENDING_QUEUE_MODE:-document_only}
      REGISTRATION_ANCHOR_GATE_ENABLED: ${REGISTRATION_ANCHOR_GATE_ENABLED:-true}
      REGISTRATION_ANCHOR_GATE_MAX_RATIO: ${REGISTRATION_ANCHOR_GATE_MAX_RATIO:-0.05}
      REGISTRATION_ANCHOR_GATE_MAX_UNANCHORED_COUNT: ${REGISTRATION_ANCHOR_GATE_MAX_UNANCHORED_COUNT:-500}
    depends_on:
      db:
        condition: service_healthy
    command: >
      sh -c "python -m app.workers.cli loop"
    volumes:
      - ./staging:/app/staging
      - ./migrations:/app/migrations:ro
      - "/Users/GY/Documents/IIVD/000001 小桔灯网/4 数据库/注册产品库/udi/UDID_FULL_RELEASE_20260205:/data/udi:ro"
      - "/Users/GY/Documents/IIVD/000001 小桔灯网/4 数据库/产品数据库/nmpa_legacy:/data/import/nmpa_legacy:ro"
    restart: unless-stopped

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8000}
      API_BASE_URL: ${API_BASE_URL:-http://api:8000}
      PENDING_QUEUE_MODE: ${PENDING_QUEUE_MODE:-document_only}
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "3000:3000"
    restart: unless-stopped
