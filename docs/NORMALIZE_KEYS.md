# Key Normalization Rules

本项目存在多来源输入（NMPA/UDI、本地注册库、人工录入等）。为了让“注册证号/备案号”能稳定匹配到 canonical 主键 `registrations.registration_no`，提供一个归一化工具：

- util：`normalize_registration_no(text) -> text`
- 代码：`api/app/services/normalize_keys.py`

## 归一化目标

把“视觉上相同、格式上不同”的注册证号，转换成一致的匹配 key，用于 join / backfill / 去重。

## 规则（V1）

1. 空值处理
- 输入为 `None` 或去掉首尾空白后为空串：返回 `None`

2. 全半角归一
- 先做 Unicode `NFKC` 归一（例如全角字母/数字转半角）

3. 去空白
- 移除所有空白字符（空格、制表符、换行等）

4. 大小写归一
- ASCII 字母转大写

5. 分隔符/标点统一
- 最终只保留：
  - 数字 `0-9`
  - ASCII 大写字母 `A-Z`
  - 中日韩统一表意文字（CJK Unified Ideographs，基本区）
- 其它字符（如 `- / _ . · （ ） ( )` 等）全部移除

## 输入输出示例

| 输入 | 输出 |
|---|---|
| `国械注准 2020-1234567` | `国械注准20201234567` |
| `国械注准2020－1234567`（全角横线） | `国械注准20201234567` |
| `  粤械注准 2019/ 8888 ` | `粤械注准20198888` |
| `ABC-123_def` | `ABC123DEF` |
| `（国）械注准2020-1234` | `国械注准20201234` |
| `""` / `"   "` / `None` | `None` |

## 注意事项

- 本规则是“匹配 key”用途：用于 join/backfill/去重，而不是用于 UI 原样展示。
- 若未来遇到新型字符集或更复杂编码，可在不破坏现有输出稳定性的前提下扩展规则。

